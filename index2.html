<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Test</title>
</head>
<body>
<h1>WebSocket Test</h1>
<div>
    <h2>Messages:</h2>
    <ul id="messagesList"></ul>
</div>
<div>
    <h2>New Message:</h2>
    <input type="text" id="messageInput">
    <button onclick="sendMessage()">Send</button>
    <input type="file" multiple id="img-uplaod"/>
    <button id="img-submit">Click Me</button>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.3.1/socket.io.js"></script>
<script>

    const messagesList = document.getElementById('messagesList');
    const messageInput = document.getElementById('messageInput');
    const token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJwaG9uZV9udW1iZXIiOiIrMzc0OTMxNTE0MjYiLCJ1c2VyX2lkIjoiNjRkYjNjYTEzNTQ4NTA0NjA4NDVkNjgxIiwiaWF0IjoxNjk0NDM5MzQyfQ.UThJDzxa2aLyYn4S1tYLnzBNOUwtG7zte7dp7pnxxFc';
    const socket = io('http://localhost:3001/chat/user', {
        query: {
            token: token,
            seller_id: '64ca78856783adaa95299931',
            buyer_id: '64db3ca1354850460845d681',
            roomId: 'dpoawkodkapokdopaskdopsakdopa'
        },
    });
    document.getElementById('img-submit').onclick = function () {
        const ourFile = document.getElementById('img-uplaod').files[0];
        const reader = new FileReader();
        reader.onloadend = function () {
            socket.emit('send-img', reader.result);
        }
        reader.readAsDataURL(ourFile);
    };

    function displayMessages(messages) {
        messagesList.innerHTML = '';
        messages.forEach(message => {
            const listItem = document.createElement('li');
            if (message.isImage) {
                const spanElement = document.createElement('span');
                spanElement.textContent = message.name;
                listItem.appendChild(spanElement);

                const imageElement = document.createElement('img');
                imageElement.src = `http://localhost:3001${message.text}`;
                listItem.appendChild(imageElement);
            } else {
                listItem.textContent = `${message.name} ${message.text}`;
            }
            messagesList.appendChild(listItem);
        });
    }
    socket.on('messages', ({messages, newMessCount}) => {
        console.log(messages)
        console.log('Received messages:');
        console.log(messages);
        console.log('New message count:');
        if (messages.length !== 0) {
            socket.emit('isRead', messages[messages.length - 1]._id)
        }
        socket.emit('getMessage')
        console.log(newMessCount);
        displayMessages(messages);
    });

    function sendMessage() {
        console.log('Sending message...');
        const message = messageInput.value;
        socket.emit('sendMessage', {text: message});
        messageInput.value = '';
    }

    socket.on('connect', () => {
        console.log('Connected to server.');
        socket.emit('getMessage');
    });
</script>
</body>
</html>
